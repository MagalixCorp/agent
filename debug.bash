#!/bin/bash

set -euo pipefail

# This is the GCP dev regional magalix cluster, under the mohamed.ahmed@magalix.com account:
# you can get the secret from the agent deployment manifest (which contains all of the k8s entities needed to install the agent):
# https://dev1.console.magalix.cloud/api/v0.1/accounts/5e95e8e3-c411-429e-8c50-2fa9a3806a21/clusters/d2483da8-d000-444e-8ad2-febaf86b2609/deployment
export ACCOUNT_ID=5e95e8e3-c411-429e-8c50-2fa9a3806a21
export CLUSTER_ID=d2483da8-d000-444e-8ad2-febaf86b2609
export SECRET="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"


if ! grep -q -- '--gateway' <<< "$@"; then
    printf "WARNING: %s\n" "--gateway flag is not specified" >&2
fi

KUBECTL_CONTEXT='--context=ctl.rgn.useast1.gcp.dev.magalix.cloud'
SERVICEACCOUNT_CA_TMP_FILEPATH=$(mktemp)
# Get the name of the secret that holds the agent serviceaccount secret:
SERVICEACCOUNT_SECRET_NAME=$(kubectl $KUBECTL_CONTEXT -n kube-system get serviceaccount magalix-agent -o json | jq --raw-output ".secrets[0].name")
# Save the ca.crt of the serviceaccount into a temp file:
kubectl $KUBECTL_CONTEXT -n kube-system get secret $SERVICEACCOUNT_SECRET_NAME -o json | jq -r '.data["ca.crt"]' | base64 -d > $SERVICEACCOUNT_CA_TMP_FILEPATH
# Save the serviceaccount token into a var:
SERVICEACCOUNT_TOKEN=$(kubectl $KUBECTL_CONTEXT -n kube-system get secret $SERVICEACCOUNT_SECRET_NAME -o json | jq -r '.data.token' | base64 -d)

go-fast-build
exec ./agent \
    --kube-url "https://api.ctl.rgn.useast1.gcp.dev.magalix.cloud" \
    --skip-namespace=kube \
    --skip-namespace=system \
    --timeout-proto-write=5s \
    --timeout-proto-read=5s \
    --timeout-proto-handshake=2s \
    --trace-log="" \
    --source=kubelet \
    --kube-root-ca-cert=$SERVICEACCOUNT_CA_TMP_FILEPATH \
    --kube-token=${SERVICEACCOUNT_TOKEN} \
    "$@"
